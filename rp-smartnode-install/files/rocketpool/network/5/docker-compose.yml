version: "3.7"
services:
  traefik:
    image: traefik:v1.7.21
    container_name: rocketpool_traefik
    command: [
      "--api",
      "--docker",
      "--docker.watch",
      "--docker.domain=smartnode.localhost",
    ]
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      net:
        aliases:
          - "eth1.rpc.smartnode.localhost"
          - "eth2.api.smartnode.localhost"
  eth1:
    image: ${ETH1_IMAGE}
    container_name: rocketpool_eth1
    restart: on-failure
    ports:
      - "30303-30305:30303-30305/udp"
      - "30303:30303/tcp"
    volumes:
      - eth1clientdata:/ethclient
      - ./chains/eth1:/setup:ro
    networks:
      - net
    environment:
      - CLIENT=${ETH1_CLIENT}
      - ETHSTATS_LABEL=${ETHSTATS_LABEL}
      - ETHSTATS_LOGIN=${ETHSTATS_LOGIN}
      - INFURA_PROJECT_ID=${INFURA_PROJECT_ID}
    entrypoint: /setup/start-node.sh
    labels:
      - traefik.enable=true
      - traefik.port=8545
      - traefik.docker.network=${COMPOSE_PROJECT_NAME}_net
      - traefik.frontend.priority=10
      - traefik.frontend.rule=Host:eth1.rpc.smartnode.localhost
      - traefik.backend.loadbalancer.stickiness=true
      - traefik.backend.loadbalancer.stickiness.cookieName=smartnodeEth1
      - traefik.backend.loadbalancer.method=drr
      - traefik.backend=eth1.rpc.smartnode
    depends_on:
      - traefik
  eth2:
    image: ${ETH2_IMAGE}
    container_name: rocketpool_eth2
    restart: on-failure
    ports:
      - "9001:9001"
    volumes:
      - eth2clientdata:/ethclient
      - ./chains/eth2:/setup:ro
    networks:
      - net
    environment:
      - CLIENT=${ETH2_CLIENT}
    entrypoint: /setup/start-beacon.sh
    labels:
      - traefik.enable=true
      - traefik.port=5052
      - traefik.docker.network=${COMPOSE_PROJECT_NAME}_net
      - traefik.frontend.priority=10
      - traefik.frontend.rule=Host:eth2.api.smartnode.localhost
      - traefik.backend.loadbalancer.stickiness=true
      - traefik.backend.loadbalancer.stickiness.cookieName=smartnodeEth2
      - traefik.backend.loadbalancer.method=drr
      - traefik.backend=eth2.api.smartnode
    depends_on:
      - eth1
  validator:
    image: ${VALIDATOR_IMAGE}
    container_name: rocketpool_validator
    restart: on-failure
    volumes:
      - ${RP_PATH}:/.rocketpool
      - ./chains/eth2:/setup:ro
    networks:
      - net
    environment:
      - CLIENT=${VALIDATOR_CLIENT}
    entrypoint: /setup/start-validator.sh
    depends_on:
      - eth2
  cli:
    image: rocketpool/smartnode:v0.0.1
    container_name: rocketpool_cli
    restart: on-failure
    volumes:
      - ${RP_PATH}:/.rocketpool
    networks:
      - net
    depends_on:
      - eth1
    entrypoint: /bin/sleep
    command: "infinity"
  node:
    image: rocketpool/smartnode:v0.0.1
    container_name: rocketpool_node
    restart: on-failure
    volumes:
      - ${RP_PATH}:/.rocketpool
    networks:
      - net
    command: "node"
    depends_on:
      - eth1
  minipools:
    image: rocketpool/smartnode:v0.0.1
    container_name: rocketpool_minipools
    restart: on-failure
    volumes:
      - ${RP_PATH}:/.rocketpool
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - net
    command: "minipools"
    depends_on:
      - eth1
      - eth2
  watchtower:
    image: rocketpool/smartnode:v0.0.1
    container_name: rocketpool_watchtower
    restart: on-failure
    volumes:
      - ${RP_PATH}:/.rocketpool
    networks:
      - net
    command: "watchtower"
    depends_on:
      - eth1
      - eth2
networks:
  net:
volumes:
  eth1clientdata:
  eth2clientdata:
